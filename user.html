<!DOCTYPE html>
<html lang="sw">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartStock | User Panel</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body{font-family:'Inter',sans-serif;margin:0;padding:0;background:#f6f8fb;color:#0f172a;}
header{background:#4CAF50;color:#fff;text-align:center;padding:12px;font-size:22px;font-weight:600;}
.container{max-width:920px;margin:0 auto;padding:12px;}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;margin-bottom:16px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#4CAF50;color:#fff;}
tr:nth-child(even){background:#f2f2f2;}
button{padding:6px 10px;border:none;border-radius:6px;background:#0b84ff;color:#fff;cursor:pointer;margin:2px;}
button.danger{background:#ef4444;}
@media(max-width:768px){th,td{padding:6px;font-size:13px;}}
</style>
</head>
<body>

<header>ðŸ“¦ SmartStock â€“ User Panel</header>
<div class="container">
  <div style="margin-bottom:12px;">
    <button id="exportExcel">Export Excel</button>
    <button id="exportPDF">Export PDF</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Product</th>
        <th>Opening Balance</th>
        <th>Stock In</th>
        <th>Stock Out</th>
        <th>Current Balance</th>
      </tr>
    </thead>
    <tbody id="productTable">
      <tr><td colspan="5">Loading...</td></tr>
    </tbody>
  </table>

  <h3>History ya Bidhaa</h3>
  <div id="historyName" style="font-weight:600;margin-bottom:6px;">Chagua bidhaa kuona history</div>
  <div id="historyList" style="max-height:240px;overflow:auto;background:#fff;padding:8px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,0.1);"></div>
</div>

<!-- Firebase SDKs -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyCtN8XDQR6klLOnu7w6C0j1mTRxQsLd9zA",
  authDomain: "stokuyamariam.firebaseapp.com",
  databaseURL: "https://stokuyamariam-default-rtdb.firebaseio.com",
  projectId: "stokuyamariam",
  storageBucket: "stokuyamariam.firebasestorage.app",
  messagingSenderId: "622453509801",
  appId: "1:622453509801:web:0b3baab46496d2746f63b8"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const productTable = document.getElementById('productTable');
const historyList = document.getElementById('historyList');
const historyName = document.getElementById('historyName');

let productsData = {};

// Load products and calculate Stock In/Out
onValue(ref(db,'products'), snap=>{
  const data = snap.val() || {};
  productsData = data;
  productTable.innerHTML='';
  for(const [pid, p] of Object.entries(data)){
    // Calculate Stock In and Stock Out from transactions
    onValue(ref(db,'transactions/'+pid), txSnap=>{
      const txs = txSnap.val() || {};
      let stockIn = 0, stockOut = 0;
      Object.values(txs).forEach(tx=>{
        if(tx.type==='in') stockIn += Number(tx.qty || 0);
        if(tx.type==='out') stockOut += Number(tx.qty || 0);
      });
      const balance = (Number(p.openingBalance)||0) + stockIn - stockOut;

      // Build table row
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><button style="background:none;border:none;color:#0b84ff;cursor:pointer" onclick="viewHistory('${pid}','${p.name}')">${p.name}</button></td>
        <td>${p.openingBalance||0}</td>
        <td>${stockIn}</td>
        <td>${stockOut}</td>
        <td>${balance}</td>
      `;
      // Replace or append
      const existingRow = productTable.querySelector(`button[onclick="viewHistory('${pid}','${p.name}')"]`)?.closest('tr');
      if(existingRow) productTable.replaceChild(row,existingRow);
      else productTable.appendChild(row);
    });
  }
});

// View history
window.viewHistory = function(pid,name){
  historyName.textContent = "History â€” "+name;
  historyList.innerHTML="Loading...";
  onValue(ref(db,'transactions/'+pid), snap=>{
    const txs = snap.val() || {};
    historyList.innerHTML='';
    Object.entries(txs).sort((a,b)=>b[1].timestamp - a[1].timestamp).forEach(([txid, tx])=>{
      const d = new Date(tx.timestamp);
      const div = document.createElement('div');
      div.style.padding="6px";
      div.style.borderBottom="1px solid #f1f5f9";
      div.innerHTML=`<strong>${tx.type.toUpperCase()} â€” ${tx.qty}</strong> | ${tx.note||''} <br><small>Balance after: ${tx.balanceAfter} | ${d.toLocaleString()}</small>`;
      historyList.appendChild(div);
    });
  });
};

// Export Excel
document.getElementById('exportExcel').onclick = ()=>{
  const ws_data = [['Product','Opening Balance','Stock In','Stock Out','Current Balance']];
  for(const [pid,p] of Object.entries(productsData)){
    // Calculate Stock In/Out
    const txsRef = ref(db,'transactions/'+pid);
    onValue(txsRef, snap=>{
      const txs = snap.val() || {};
      let stockIn=0, stockOut=0;
      Object.values(txs).forEach(tx=>{
        if(tx.type==='in') stockIn += Number(tx.qty || 0);
        if(tx.type==='out') stockOut += Number(tx.qty || 0);
      });
      const balance = (Number(p.openingBalance)||0) + stockIn - stockOut;
      ws_data.push([p.name||'',p.openingBalance||0,stockIn,stockOut,balance]);
    });
  }
  setTimeout(()=>{
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'SmartStock');
    XLSX.writeFile(wb,'SmartStock.xlsx');
  },500); // give time to calculate stock
};

// Export PDF
document.getElementById('exportPDF').onclick = ()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(12);
  doc.text("SmartStock Report",14,14);
  let y=24;
  doc.text("Product | Opening | Stock In | Stock Out | Balance",14,y);
  y+=6;
  for(const [pid,p] of Object.entries(productsData)){
    const txsRef = ref(db,'transactions/'+pid);
    onValue(txsRef,snap=>{
      const txs = snap.val() || {};
      let stockIn=0, stockOut=0;
      Object.values(txs).forEach(tx=>{
        if(tx.type==='in') stockIn += Number(tx.qty || 0);
        if(tx.type==='out') stockOut += Number(tx.qty || 0);
      });
      const balance = (Number(p.openingBalance)||0)+stockIn-stockOut;
      doc.text(`${p.name} | ${p.openingBalance||0} | ${stockIn} | ${stockOut} | ${balance}`,14,y);
      y+=6;
      if(y>280){doc.addPage();y=20;}
    });
  }
  setTimeout(()=>{ doc.save("SmartStock.pdf"); },500);
};
</script>

<!-- SheetJS -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

</body>
</html>
